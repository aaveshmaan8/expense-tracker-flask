<!DOCTYPE html>
<html lang="en">
<head>
    <title>Register | Expense Tracker</title>

    <!-- Font Awesome -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- App CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<div class="auth-container">
    <div class="auth-card fade-in">

        <h2>Create Account</h2>
        <p class="auth-subtitle">Track your expenses smartly</p>

        <!-- FLASH MESSAGES -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="auth-alert {{ 'auth-success' if category == 'success' else 'auth-error' }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        <form method="POST" onsubmit="return validateForm()">

            <!-- Username -->
            <label>Username</label>
            <input type="text"
                   name="username"
                   id="username"
                   required
                   minlength="3"
                   autocomplete="username"
                   placeholder="Choose a username"
                   oninput="validateUsername()">

            <div id="userHint" class="password-match"></div>

            <!-- Password -->
            <label>Password</label>
            <div class="password-wrapper">
                <input type="password"
                       id="password"
                       name="password"
                       required
                       autocomplete="new-password"
                       placeholder="Minimum 6 characters"
                       oninput="checkStrength()"
                       onkeyup="checkCaps(event)">
                <i class="fa-solid fa-eye toggle-password"
                   onclick="togglePassword('password', this)"></i>
            </div>

            <!-- Caps Lock Warning -->
            <div id="capsWarning"
                 class="password-match error"
                 style="display:none;">
                ⚠ Caps Lock is ON
            </div>

            <!-- Strength -->
            <div id="strengthText" class="password-strength"></div>

            <!-- Confirm Password -->
            <label>Confirm Password</label>
            <div class="password-wrapper">
                <input type="password"
                       id="confirm_password"
                       required
                       autocomplete="new-password"
                       placeholder="Re-enter password"
                       oninput="checkMatch()">
                <i class="fa-solid fa-eye toggle-password"
                   onclick="togglePassword('confirm_password', this)"></i>
            </div>

            <!-- Match Result -->
            <div id="matchText" class="password-match"></div>

            <!-- Submit -->
            <button type="submit"
                    id="registerBtn"
                    class="auth-btn"
                    disabled>
                Create Account
            </button>
        </form>

        <div class="auth-footer">
            Already have an account?
            <a href="{{ url_for('login') }}">Login</a>
        </div>

    </div>
</div>

<!-- ================= SCRIPTS ================= -->
<script>
const registerBtn = document.getElementById("registerBtn");

/* Toggle password visibility */
function togglePassword(id, icon) {
    const input = document.getElementById(id);
    const hidden = input.type === "password";
    input.type = hidden ? "text" : "password";
    icon.classList.toggle("fa-eye", !hidden);
    icon.classList.toggle("fa-eye-slash", hidden);
}

/* Caps Lock warning */
function checkCaps(e) {
    const warning = document.getElementById("capsWarning");
    if (!e.getModifierState) return;
    warning.style.display = e.getModifierState("CapsLock") ? "block" : "none";
}

/* Username validation */
function validateUsername() {
    const user = document.getElementById("username").value.trim();
    const hint = document.getElementById("userHint");

    if (user.length < 3) {
        hint.textContent = "Username must be at least 3 characters";
        hint.className = "password-match error";
        registerBtn.disabled = true;
    } else {
        hint.textContent = "";
        checkMatch();
    }
}

/* Password strength */
function checkStrength() {
    const pwd = document.getElementById("password").value;
    const strength = document.getElementById("strengthText");

    if (!pwd) {
        strength.textContent = "";
        strength.className = "password-strength";
        checkMatch();
        return;
    }

    if (pwd.length < 6) {
        strength.textContent = "Weak password";
        strength.className = "password-strength weak";
    } else if (/[A-Z]/.test(pwd) && /[0-9]/.test(pwd)) {
        strength.textContent = "Strong password";
        strength.className = "password-strength strong";
    } else {
        strength.textContent = "Medium strength password";
        strength.className = "password-strength medium";
    }

    checkMatch();
}

/* Password match */
function checkMatch() {
    const pwd = document.getElementById("password").value;
    const confirm = document.getElementById("confirm_password").value;
    const match = document.getElementById("matchText");

    if (!confirm || pwd.length < 6) {
        match.textContent = "";
        registerBtn.disabled = true;
        return;
    }

    if (pwd !== confirm) {
        match.textContent = "Passwords do not match";
        match.className = "password-match error";
        registerBtn.disabled = true;
    } else {
        match.textContent = "Passwords match ✓";
        match.className = "password-match strong";
        registerBtn.disabled = false;
    }
}

/* Final validation */
function validateForm() {
    registerBtn.innerHTML =
        '<i class="fa-solid fa-spinner fa-spin"></i> Creating...';
    registerBtn.disabled = true;
    return true;
}
</script>

</body>
</html>
